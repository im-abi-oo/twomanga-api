راهنمای فنی و مستندات سیستم Two Manga

این مستند شامل جزئیات لازم برای برنامه نویسان فرانت‌سند و مدیران سیستم جهت کار با بک‌اِند است.

۱. معماری امنیت و سشن‌ها

این سیستم از متد Single Session استفاده می‌کند.

در هر بار لاگین، یک session_salt جدید تولید شده و در توکن JWT جایگذاری می‌شود.

اگر کاربر با دستگاه جدیدی وارد شود، تمام توکن‌های دستگاه قبلی به دلیل عدم تطابق Salt با دیتابیس، بلافاصله ابطال (401 Unauthorized) می‌شوند.

۲. لیست اندپوینت‌ها (API Reference)

بخش احراز هویت (Auth)

متد

اندپوینت

توضیحات

POST

/auth/register

ثبت‌نام کاربر جدید (نیاز به username, password, telegram_id)

POST

/auth/login

ورود و دریافت access_token و refresh_token

POST

/auth/refresh

تمدید Access Token با استفاده از Refresh Token در هدر

بخش کاربری (User)

متد

اندپوینت

توضیحات

GET

/api/user/status

دریافت وضعیت اشتراک، روزهای باقی‌مانده و تعداد خریدها

POST

/payment/submit

ارسال هش تراکنش کریپتویی یا کد کوپن هدیه

بخش مدیریت (Admin)

متد

اندپوینت

توضیحات

POST

/admin/system/coupon

تولید کد کوپن هدیه (نیاز به هدر X-Admin-Secret)

GET

/admin/system/stats

مشاهده آمار کلی کاربران و فروش (نیاز به لاگین ادمین)

۳. راهنمای دکمه‌های عملیاتی تلگرام

سیستم به صورت خودکار از طریق Threading بر روی متد getUpdates تلگرام شنود می‌کند. فرآیند تایید به شرح زیر است:

ارسال توسط کاربر: کاربر در فرانت‌سند هش تراکنش را ارسال می‌کند.

اعلان به ادمین: پیامی در تلگرام برای تمام ادمین‌های لیست شده در .env ارسال می‌شود.

دکمه [✅ تایید]:

با کلیک ادمین، وب‌هوک داخلی فراخوانی شده و اشتراک کاربر بلافاصله تمدید می‌گردد.

پیامی در کانال لاگ ثبت شده و به کاربر اطلاع‌رسانی می‌شود.

دکمه [❌ رد]:

تراکنش رد شده و کاربر پیام عدم تایید دریافت می‌کند.

۴. استقرار (Deployment) پیشنهاد شده

برای اجرای بدون وقفه در محیط عملیاتی:

استفاده از Gunicorn برای مدیریت ریکوئست‌ها.

استفاده از PM2 برای مدیریت پروسه پایتون:
pm2 start app.py --interpreter python3 --name manga-backend

تنظیم Nginx به عنوان Reverse Proxy برای مدیریت SSL و دامنه.

۵. عیب‌یابی (Troubleshooting)

خطای CORS: مطمئن شوید آدرس فرانت‌سند شما دقیقاً در ALLOWED_ORIGINS فایل .env وجود دارد.

بات پاسخ نمی‌دهد: توکن بات را بررسی کرده و مطمئن شوید سرور به api.telegram.org دسترسی دارد (رفع فیلتر در صورت لزوم).

کراش سرور: هرگونه خطای بحرانی به صورت خودکار برای ادمین‌ها در تلگرام ارسال می‌شود.
